<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Node Development Training</title>

		<meta name="description" content="Slides to compliment a training course on Node.js development at NAP">
		<meta name="author" content="Matthew Green">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

	</head>

	<body>

	<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
	<div class="slides">
		<section style="text-align: center;">
			<h1>Node Development Training</h1>
			<h3>For NAP Tech</h3>
			<p>
				<small>Matthew Green / <a href="http://twitter.com/mjgreen145">@mjgreen145</a></small>
			</p>
		</section>

		<section>
			<h2>Agenda</h2>
			<ol style="display: flex;">
				<div style="flex: 1 50%;">
					<li class="fragment">
						<span>Basics of Node</span>
						<ul>
							<li>Node.js</li>
							<li>NPM</li>
							<li>Common modules</li>
						</ul>
					</li>
					<li class="fragment">
						<span>Express.js</span>
						<ul>
							<li>Basic Server</li>
							<li>Routes</li>
							<li>Middleware Pattern</li>
						</ul>
					</li>
					<li class="fragment">Handlebars</li>
					<li class="fragment">Girdle</li>
				</div>
				<div style="flex: 1 50%;">
					<li class="fragment">
						<span>Testing</span>
						<ul>
							<li>Tools for Node Testing</li>
							<li>Tools for Client-side testing</li>
							<li>Coverage Tools</li>
						</ul>
					</li>
					<li class="fragment">
						<span>Build & Deployment</span>
						<ul>
							<li>Grunt & NPM scripts</li>
							<li>Jenkins</li>
						</ul>
					</li>
					<li class="fragment">
						<span>AWS</span>
						<ul>
							<li>Infrastructure & Cloudformation</li>
							<li>Monitoring</li>
						</ul>
					</li>
				</div>
			</ol>
		</section>

		<!-- ***************** 1. Basics of Node.js ***************** -->

		<section>
			<h1>Basics of Node.js</h1>
		</section>

		<section>
			<h2>What is Node?</h2>
			<ul>
				<li class="fragment">Javascript runtime environment</li>
				<li class="fragment">Built on Chrome's V8 engine</li>
				<li class="fragment">Event-driven</li>
				<li class="fragment">Non-blocking I/O</li>
				<li class="fragment">Single-threaded</li>
			</ul>
			<aside class="notes">
				Switch to terminal and run basic JS in REPL
			</aside>
		</section>

    <section>
      <h2>Synchronous execution</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
function getData(id) {
  var data = readFile('/path/to/dir/' + id);
  return data;
}

var myData = getData(123);
console.log(myData);
      </code></pre>
      <ul>
        <li class="fragment">Fine in a multi threaded system</li>
        <li class="fragment">Works in Node - but blocked while reading each file</li>
        <li class="fragment">Can't serve more requests until the current one is done</li>
      </ul>
      <aside class="notes">
        Node is single threaded, so any long running work which is blocking will cause a lack of throughput in an app
      </aside>
    </section>

    <section>
      <h2>Asynchronous execution</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
function getData(id, callback) {
  var data = readFile('/path/to/dir/' + id);
  callback(data);
}

var myData = getData(123, function(data) {
  console.log(myData);  
});
      </code></pre>
      <ul>
        <li class="fragment">Node can execute this asynchronously</li>
        <li class="fragment">Callback is called when ready, then Node processes it</li>
      </ul>
      <aside class="notes">
        Node is single threaded, so any long running work which is blocking will cause a lack of throughput in an app
      </aside>
    </section>

		<section>
			<h2>Modular</h2>
			<ul>
				<li>Larger applications/libraries built up of small modules</li>
			</ul>
			<pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
var myModule = require('my-module');
			</code></pre>
		</section>				

    <section>
      <h2>NPM</h2>
      <ul>
        <li class="fragment">Node Package Manager</li>
        <li class="fragment">A place to publish, install and manage Node modules</li>
        <li class="fragment">Similar to Maven in Java-world</li>
      </ul>
    </section>

    <section>
      <h2>Installing a module</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code data-trim>
$ npm install express
      </code></pre>
      <ul>
        <li class="fragment">Installs the express module in your project's node_modules directory</li>
        <li class="fragment">Also installs all of express's dependencies in its local node_modules directory</li>
        <li class="fragment">... and so on</li>
      </ul>
    </section>

    <section>
      <pre style="margin: 0; width: 100%;"><code data-trim>
â”œâ”€â”€ index.js
â”œâ”€â”€ node_modules
â”‚Â Â  â””â”€â”€ express
â”‚Â Â      â”œâ”€â”€ src
â”‚Â Â      â”‚Â Â  â””â”€â”€ express.js
â”‚Â Â      â”œâ”€â”€ node_modules
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ dependency1
â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ ...
â”‚Â Â      â”‚Â Â  â””â”€â”€ dependency2
â”‚Â Â      â”‚Â Â   Â Â  â””â”€â”€ ...
â”‚Â Â      â””â”€â”€ package.json
â””â”€â”€ package.json
      </code></pre>
    </section>

    <section>
      <h2>Using a module</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code data-trim>
var express = require('express');
      </code></pre>
      <ul>
        <li class="fragment">What is the 'express' variable?</li>
      </ul>
    </section>

    <section>
      <h2>Exporting & Requiring</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
// my-module.js
module.exports = "Hello World!";
      </code></pre>

      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
var foo = require('./my-module'); // foo = "Hello World!"
      </code></pre>
    </section>

    <section>
      <h2>Example - Maths</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
module.exports = {
  add: function(x, y) {
    return x+y;
  },
  subtract: function(x, y) {
    return x-y;
  },
  multiply: function(x, y) {
    return x*y;
  },
  divide: function(x, y) {
    return x/y;
  }
};
      </code></pre>
      <aside class="notes">
        Load maths.js
      </aside>
    </section>

    <section>
      <h2>Execution Flow</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
console.log('One');

function foo() { console.log('Two'); }

module.exports = 'Three';

foo();
      </code></pre>
      <aside class="notes">
        <ul>
          <li>Load flow.js</li>
          <li>Explain order of output</li>
          <li>Load again - explain caching</li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>package.json</h2>
      <ul>
        <li class="fragment">JSON file to contain all metadata for your module/app</li>
        <li class="fragment">Defines name, description, version, dependencies etc..</li>
      </ul>
    </section>

    <section>
      <h2>Example</h2>
      <pre class="fragment" style="margin: -50px 0 0; width: 100%;"><code class="hljs" data-trim>
{
  "name": "country-service",
  "version": "1.0.0",
  "description": "A module which does cool things",
  "main": "index.js",
  "scripts": {
    "test": "node_modules/.bin/istanbul cover _mocha -- -R spec",
    "coverage": "node_modules/.bin/istanbul check-coverage --statement 100",
    "lint": "node_modules/.bin/jshint src/*.js test/*.js index.js"
  },
  "author": "NAP Product Team",
  "license": "Apache-2.0",
  "repository": {
    "type": "http",
    "url": "http://stash.vm.wtf.nap/scm/nap/country-service.git"
  },
  "dependencies": {
    "express": "~4.13.3"
  },
  "devDependencies": {
    "chai": "^3.4.1",
    "express": "^4.13.3",
    "mocha": "^2.3.4",
  }
}
      </code></pre>
    </section>

    <section>
      <h2>package.json - name</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
{
  "name": "api-stubs"
}
      </code></pre>
      <ul>
        <li class="fragment">The name of the module</li>
        <li class="fragment">The name to 'require' if you want to use the module</li>
      </ul>
    </section>

    <section>
      <h2>package.json - main</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
{
  "main": "index.js",
}
      </code></pre>
      <ul>
        <li class="fragment">The entry point for the module</li>
        <li class="fragment">The file which is parsed and exported when you 'require' this module</li>
      </ul>
    </section>

    <section>
      <h2>package.json - scripts</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
"scripts": {
  "test": "node_modules/.bin/istanbul cover _mocha -- -R spec",
  "coverage": "node_modules/.bin/istanbul check-coverage --statement 100",
  "lint": "node_modules/.bin/jshint src/*.js test/*.js index.js",
  "start": "node index.js"
},
      </code></pre>
      <ul>
        <li class="fragment">A collection of executable commands</li>
        <li class="fragment">Execute using <code class="hljs" data-trim style="display: inline; padding: 0 10px;">npm run</code>, e.g. <code class="hljs" data-trim style="display: inline; padding: 0 10px;">npm run coverage</code></li>
        <li class="fragment">'start', 'stop', and 'test' have shortcuts</li>
        <li class="fragment"><code class="hljs" data-trim style="display: inline; padding: 0 10px;">npm start</code>, <code class="hljs" data-trim style="display: inline; padding: 0 10px;">npm stop</code>, <code class="hljs" data-trim style="display: inline; padding: 0 10px;">npm test</code></li>
      </ul>
    </section>

    <section>
      <h2>package.json - dependencies</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
{
  "dependencies": {
    "express": "~4.13.3"
  },
  "devDependencies": {
    "chai": "^3.4.1",
    "mocha": "^2.3.4",
  }
}
      </code></pre>
      <ul>
        <li class="fragment">Defines all of the modules you module depends on to work</li>
        <li class="fragment">"dependencies" = runtime, "devDependencies" = everything else</li>
        <li class="fragment">Use <code class="hljs" data-trim style="display: inline; padding: 0 10px;">npm install</code> to install into local node_modules folder</li>
        <li class="fragment">Use <code class="hljs" data-trim style="display: inline; padding: 0 10px;">npm install --production</code> to install only "dependencies"</li>
      </ul>
    </section>

    <section>
      <h2>package.json - dependencies</h2>
      <ul>
        <li class="fragment">To add install a module and save to your package.json file:</li>
        <li class="fragment"><code class="hljs" data-trim style="display: inline; padding: 0 10px;">npm install express --save</code></li>
        <li class="fragment"><code class="hljs" data-trim style="display: inline; padding: 0 10px;">npm install mocha --save-dev</code></li>
      </ul>
    </section>

    <section>
      <h2>Common Modules - built-in</h2>
      <ul>
        <li class="fragment">fs (File System)</li>
        <li class="fragment">path (File Paths)</li>
        <li class="fragment">url (URL helpers)</li>
      </ul>
    </section>

    <section>
      <h2>Common Modules - NPM</h2>
      <ul>
        <li class="fragment">express (HTTP Framework)</li>
        <li class="fragment">handlebars (Templating)</li>
        <li class="fragment">express-handlebars (More powerful features when using Handlebars + Express)</li>
        <li class="fragment">i18n (Translations)</li>
        <li class="fragment">mocha, sinon, chai (Testing)</li>
      </ul>
    </section>

    <section>
      <h2>Common Modules - NAP</h2>
      <ul>
        <li class="fragment">rest-http (HTTP Requests)</li>
        <li class="fragment">localise-url (URL localising)</li>
        <li class="fragment">country-service (NAP locale data)</li>
        <li class="fragment">nap-logging (Common logger)</li>
      </ul>
    </section>

    <!-- ***************** 2. Express.js ***************** -->

    <section>
      <h1>Express.js</h1>
    </section>

    <section>
      <h2>Basic Server</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
// server.js
var express = require('express');

var app = express();

app.listen(3000, function(){
  console.log('App started on port 3000');
});
      </code></pre>
      <aside class="notes">
        Easy first server, but doesn't do anything...
      </aside>
    </section>

    <section>
      <h2>Basic Server</h2>
      <pre style="margin: 0; width: 100%;"><code class="hljs" data-trim>
// server.js
var express = require('express');

var app = express();

app.get('/', function(req, res) {
  res.send('Hello World!');
});

app.listen(3000, function(){
  console.log('App started on port 3000');
});
      </code></pre>
      <aside class="notes">
        Run this, and prove it works
      </aside>
    </section>

    <section>
      <h2>Moar routes!</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
// routes.js
var setupRoutes = function(app) {

  app.get('/', function(req, res) {
    res.send('Hello World!');
  });

  app.get('/welcome', function(req, res) {
    res.send('Welcome!');
  });

};

module.exports = {
  setupRoutes: setupRoutes
};
      </code></pre>
      <aside class="notes">
        Let's separate the routes into their own file for clarity
      </aside>
    </section>

    <section>
      <h2>Moar routes!</h2>
      <pre style="margin: 0; width: 100%;"><code class="hljs" data-trim>
// server.js
var express = require('express');

var app = express();

require('./routes/routes').setupRoutes(app);

app.listen(3000, function(){
  console.log('App started on port 3000');
});
      </code></pre>
      <aside class="notes">
        Let's separate the routes into their own file for clarity
      </aside>
    </section>

    <section>
      <h2>Variable URLs</h2>
      <ul>
        <li class="fragment">
          <span>You can't hard code every URL:</span>
          <ul class="fragment">
            <li>/gb/en/product/157935</li>
            <li>/us/fr/product/649761</li>
            <li>/cn/zh/product/546973</li>
          </ul>
        </li>
      </ul>
    </section>

    <section>
      <h2>URL Parameters</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
app.get('/:country/:language/product/:pid', function(req, res) {
  res.send(req.params);
});
      </code></pre>
      <aside class="notes">
        Run this to see the output
      </aside>
    </section>

    <section>
      <h2>Middleware Pattern</h2>
      <ul class="fragment">
        <li>Design pattern used by Express</li>
        <li>Similar to Filter Chain Pattern in Java</li>
      </ul>
    </section>

    <section>
      <h2>What is Middleware?</h2>
      <ul class="fragment">
        <li>Functions which have access to the <code class="hljs" data-trim style="display: inline; padding: 0 10px;">request</code>, <code class="hljs" data-trim style="display: inline; padding: 0 10px;">response</code>, and <code class="hljs" data-trim style="display: inline; padding: 0 10px;">next</code>, piece of middleware in the chain</li>
      </ul>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
function(req, res, next) {
  // ...
};
      </code></pre>
    </section>

    <section>
      <h2>What is Middleware?</h2>
      <ul>
        <li class="fragment">
          <span>Middleware can:</span>
          <ul>
            <li class="fragment">Execute code</li>
            <li class="fragment">Alter the <code class="hljs" data-trim style="display: inline; padding: 0 10px;">request</code> and <code class="hljs" data-trim style="display: inline; padding: 0 10px;">response</code> objects</li>
            <li class="fragment">End the request</li>
            <li class="fragment">Call the <code class="hljs" data-trim style="display: inline; padding: 0 10px;">next</code> middleware function in the chain</li>
          </ul>
        </li>
        <li class="fragment">If a piece of Middleware does not either end the request, or call <code class="hljs" data-trim style="display: inline; padding: 0 10px;">next()</code>, the request will be left hanging</li>
      </ul>
    </section>

    <section data-background="#EEEEEE">
      <img src="/images/middleware1.png" style="display: block; width: 75%; margin: 0 auto;"/>
    </section>

    <section>
      <h2>Types of Middleware</h2>
      <ul class="fragment">
        <li>Application-level Middleware</li>
      </ul>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
app.use(function(req, res, next) {
  console.log('The time is: ' + Date.now());
  next();
});
      </code></pre>
      <ul class="fragment">
        <li>This will be called on all requests into the app</li>
      </ul>
    </section>

    <section>
      <h2>Types of Middleware</h2>
      <ul class="fragment">
        <li>Router-level Middleware</li>
      </ul>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
app.get('/hello', function(req, res, next) {
  console.log('Hello to you too');
  next();
}, function(req, res){
  res.send('Hello, World!');
});
      </code></pre>
      <ul class="fragment">
        <li>Bound to requests which match this route</li>
      </ul>
      <aside class="notes">
        Note the use of two bits of middleware here
      </aside>
    </section>

    <section>
      <h2>Types of Middleware</h2>
      <ul class="fragment">
        <li>Error-Handling Middleware</li>
      </ul>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
app.use(function(err, req, res, next) {
  console.log(err);
  res.status(500).send('Error!!!');
});
      </code></pre>
      <ul>
        <li class="fragment">Separate from the main middleware chain</li>
        <li class="fragment">Four arguments makes Express use this as error middleware</li>
        <li class="fragment">Invoked if you call <code class="hljs" data-trim style="display: inline; padding: 0 10px;">next</code> with a parameter - e.g. <code class="hljs" data-trim style="display: inline; padding: 0 10px;">next('error')</code></li>
      </ul>
      <aside class="notes">
        If you invoke error middleware, all other middlewares are skipped over
        Note the need for the next parameter, even if it isn't used, for Express to interpret this as error middleware.
      </aside>
    </section>

    <section>
      <h2>Organise your Middleware</h2>
      <pre style="margin: 0; width: 100%;"><code data-trim>
â”œâ”€â”€ app
â”‚Â Â  â”œâ”€â”€ middleware
â”‚Â Â  â”‚   â”œâ”€â”€ middleware1.js
â”‚Â Â  â”‚   â”œâ”€â”€ middleware2.js
â”‚Â Â  â”‚   â”œâ”€â”€ middleware3.js
â”‚Â Â  â”‚   â””â”€â”€ middleware4.js
â”‚Â Â  â”œâ”€â”€ routes
â”‚Â Â  â”‚   â””â”€â”€ routes.js
â”‚Â Â  â””â”€â”€ server.js
â”‚
â”œâ”€â”€ node_modules
â””â”€â”€ package.json
      </code></pre>
    </section>

    <section>
      <h2>Organise your Middleware</h2>
      <pre style="margin: 0; width: 100%;"><code data-trim>
var middleware1 = require('../middleware/middleware1');
var middleware2 = require('../middleware/middleware2');
var middleware3 = require('../middleware/middleware3');

var setupRoutes = function(app) {
  
  app.get('/', [
    middleware1.doSomething(),
    middleware2.doSomething(),
    middleware3.doSomething(),
    function(req, res) {
      res.send(200) 
    }
  ]);

};
      </code></pre>
      <aside class="notes">
        Full example / exercise to come, but after Handlebars
      </aside>
    </section>

    <!-- ***************** 3. Handlebars ***************** -->

    <section>
      <h1>Handlebars</h1>
    </section>

    <section>
      <h2>Handlebars</h2>
      <ul>
        <li class="fragment">Templating library</li>
        <li class="fragment">Converts templates into rendered strings</li>
        <li class="fragment">Logicless (almost)</li>
        <li class="fragment">Typically used to render HTML templates into HTML</li>
      </ul>
    </section>

    <section>
      <h2>Example</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="html" data-trim>
&lt;html&gt;
  &lt;head&gt;&lt;/head&gt;
  &lt;body&gt;
    Hello {{name}}!
  &lt;/body&gt;
&lt;/html&gt;
      </code></pre>
      <pre class="fragment" style="margin: 0; width: 100%;"><code data-trim>
app.get('/user/:name', function(req, res) {
  var template = fs.readFileSync('./views/user.hbs').toString();

  var html = handlebars.compile(template)({
    name: req.params.name
  });

  res.send(html);
});

      </code></pre>
    </section>

    <section>
      <h2>Nested data</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="html" data-trim>
Hello {{user.name}}, your ID is {{user.id}}
      </code></pre>
      <pre class="fragment" style="margin: 0; width: 100%;"><code data-trim>
handlebars.compile(template)({
  user: {
    name: 'Matt',
    id: '123456789'
  }
});
      </code></pre>
    </section>

    <section>
      <h2>Helpers - Lists</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="html" data-trim>
&lt;ul&gt;      
  {{#each users}}
    &lt;li&gt;{{this}}&lt;/li&gt;
  {{/each}}
&lt;/ul&gt;
      </code></pre>
    </section>

    <section>
      <h2>Helpers - if / else / unless</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="html" data-trim>
Hello {{user.name}}, your ID is {{user.id}}
{{#if user.isManager}}
  You are a manager!
{{/if}}
      </code></pre>

      <pre class="fragment" style="margin: 0; width: 100%;"><code class="html" data-trim>
Hello {{user.name}}, your ID is {{user.id}}
{{#if user.isManager}}
  You are a manager!
{{#else}}
  You are not a manager
{{/if}}
      </code></pre>

      <pre class="fragment" style="margin: 0; width: 100%;"><code class="html" data-trim>
Hello {{user.name}}, your ID is {{user.id}}
{{#unless user.isManager}}
  You are not a manager
{{/unless}}
      </code></pre>
    </section>

    <section>
      <h2>Express + Handlebars</h2>
      <ul>
        <li class="fragment">Manually loading files & compiling = ðŸ˜ž</li>
        <li class="fragment">Vanilla Handlebars has no support for partials</li>
        <li class="fragment">Defining your own helpers is messy</li>
      </ul>
    </section>

    <section>
      <h2>express-handlebars module</h2>
      <ul>
        <li class="fragment">Module which extends the power of handlebars</li>
        <li class="fragment">Nice integration on Handlebars with Express</li>
        <li class="fragment">Puts back nice functionality which was removed from Express</li>
      </ul>
      <aside class="notes">
        Express 3.x removed a lot of view engine features
        This was a good move, because it meant developers could 
        use view engines of their choice.
        This module now contains a lot of the Handlebars specific 
        functionality which was removed from Express
      </aside>
    </section>

    <section>
      <h2>Views - layouts and partials</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="hljs" data-trim>
app
â””â”€â”€ views
 Â Â  â”œâ”€â”€ layouts
 Â   â”‚   â””â”€â”€ index.hbs
 Â Â  â””â”€â”€ partials
 Â       â”œâ”€â”€ head.hbs
 Â       â””â”€â”€ body.hbs
      </code></pre>
    </section>

    <section>
      <h2>Layout - index.hbs</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="html" data-trim>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  {{> head }}
&lt;/head&gt;
&lt;body&gt;
  {{> body }}
&lt;/body&gt;
&lt;/html&gt;
      </code></pre>
    </section>

    <section>
      <h2>Partials</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="html" data-trim>
&lt;!-- head.hbs --&gt;
<meta charset="utf-8">
<title>My Handlebars Page</title>
      </code></pre>

      <pre class="fragment" style="margin: 0; width: 100%;"><code class="html" data-trim>
&lt;!-- body.hbs --&gt;
<h1>Hello, {{user}}!</h1>
      </code></pre>
    </section>

    <section>
      <h2>Some config...</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="js" data-trim>
var path = require('path');
var rootPath = path.resolve(__dirname);

var express = require('express');
var exphbs  = require('express-handlebars');

var app = express();
var hbs = exphbs.create({
  extname: '.hbs',
  partialsDir: rootPath + '/views/partials'
});

app.engine('.hbs', hbs.engine);
app.set('view engine', '.hbs');
app.set('views', rootPath + '/views/layouts');
      </code></pre>
      <aside class="notes">
        Explain all this.
      </aside>
    </section>

    <section>
      <h2>Render it</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="js" data-trim>
app.get('/handlebars/:user', function(req, res) {
    
  res.render('index', {
    user: req.params.user
  }, function(err, html) {
    if (err) {
      res.status(500).send(err);
    } else {
      res.status(200).send(html);  
    }
  });

});
      </code></pre>
      <aside class="notes">
        Explain the second parameter - the data for the view
        Explain this is optional - can be a callback as a second parameter. 
      </aside>
    </section>

    <section>
      <h2>res.locals</h2>
      <ul>
        <li class="fragment">Object which can contain data for the view</li>
        <li class="fragment">Scoped to each individual request/response</li>
      </ul>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="js" data-trim>
app.get('/handlebars/:user', function(req, res) {

  res.locals = { user: req.params.user };
    
  res.render('index', function(err, html) {
    if (err) {
      res.status(500).send(err);
    } else {
      res.status(200).send(html);  
    }
  });

});
      </code></pre>
    </section>

    <section>
      <h2>Controllers</h2>
      <ul>
        <li class="fragment">A middleware dedicated to rendering and responding</li>
      </ul>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="js" data-trim>
// controller.js
var controller = {
  render: function(req, res) {
    res.render('index', function(err, html) {
      if (err) {
        res.status(500).send(err);
      } else {
        res.status(200).send(html);  
      }
    });
  }
};

module.exports = controller;
      </code></pre>
    </section>

    <section>
      <h2>Controllers</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="js" data-trim>
var controller = require('../controllers/controller');

app.get('/handlebars/:user',
  function(req, res, next) {
    res.locals = { user: req.params.user };
    next();
  },
  controller.render
);
      </code></pre>
      <aside class="notes">
        Lets tidy up our route
      </aside>
    </section>

    <section>
      <h2>Tidying up..</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="js" data-trim>
var controller = require('../controllers/controller');
var userMiddleware = require('../middleware/userMiddleware');

app.get('/handlebars/:user',
  userMiddleware.getUser,
  controller.render
);
      </code></pre>

      <pre class="fragment" style="margin: 0; width: 100%;"><code class="js" data-trim>
var userMiddleware = {
  getUser: function(req, res, next) {
    res.locals = {
      user: req.params.user
    };
    next();
  }
};

module.exports = userMiddleware;
      </code></pre>
      <aside class="notes">
        Lets tidy up our route
      </aside>
    </section>

    <section>
      <h2>How does render() work?</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="js" data-trim>
app.get('/user/:name', function(req, res) {
  var template = fs.readFileSync('./views/user.hbs').toString();

  var html = handlebars.compile(template)({
    name: req.params.name
  });

  res.send(html);
});
      </code></pre>

      <pre class="fragment" style="margin: 0; width: 100%;"><code class="js" data-trim>
app.get('/handlebars/:user', function(req, res) {
    
  res.render('index', {
    user: req.params.user
  }, function(err, html) {
    res.send(html);  
  });

});
      </code></pre>
    </section>

    <section>
      <h2>How does render() work?</h2>
      <ul>
        <li>
          <span>Once in production..</span>
          <ul>
            <li class="fragment">The file loaded from disk won't change</li>
            <li class="fragment">The compiled template won't change</li>
            <li class="fragment">Only the rendered HTML will change - based on the data</li>
          </ul>
        </li>
        <li class="fragment">No need to do file loading or compiling on each request!</li>
      </ul>
    </section>

    <section>
      <h2>Efficient Rendering</h2>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="js" data-trim>
var file = fs.readFileSync('./views/user.hbs').toString();
var template = handlebars.compile(file);

app.get('/user/:name', function(req, res) {
  
  template({
    name: req.params.name
  });

  res.send(html);
});
      </code></pre>
    </section>

    <section>
      <h2>What about res.render()?</h2>
      <ul>
        <li class="fragment">We're not loading the templates ourselves</li>
        <li class="fragment">Can we achieve the same thing in Express-Handlebars?</li>
      </ul>
      <pre class="fragment" style="margin: 0; width: 100%;"><code class="js" data-trim>
app.enable('view cache');
      </code></pre>
      <ul>
        <li class="fragment">Express will cache the rendered templates for each view</li>
        <li class="fragment">Removes any I/O or CPU intensive work from request/response cycle</li>
      </ul>
      <aside class="notes">
        We've just stopped loading manually, so hwo do we achieve it with Express?
      </aside>
    </section>

    <!-- Advanced topics
      Helpers
     -->

	</div>

	</div>

	<script src="lib/js/head.min.js"></script>
	<script src="js/reveal.js"></script>

	<script>

		// Full list of configuration options available at:
		// https://github.com/hakimel/reveal.js#configuration
		Reveal.initialize({
			controls: false,
			progress: true,
			history: true,
			center: true,

			transition: 'slide', // none/fade/slide/convex/concave/zoom

			// Optional reveal.js plugins
			dependencies: [
				{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
				{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
				{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
				{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
				{ src: 'plugin/zoom-js/zoom.js', async: true },
				{ src: 'plugin/notes/notes.js', async: true }
			]
		});

	</script>

	</body>
</html>
